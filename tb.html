<html>
<head>
  <meta charset="utf-8" />
  <title>Color Rank & Hold-to-Highlight</title>
  <style>
    body {
      background-color: #808080;
      font-size: 200%;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    #colorList {
      font-weight: bold;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      list-style-position: inside;
      padding-left: 0;
      margin: 0.5em 0;
    }
    #colorList li {
      cursor: pointer;
      user-select: none;
      padding: .15em .25em;
      border-radius: .35em;
      transition: background-color .15s ease;
    }
    #colorList li:hover { background-color: rgba(255,255,255,.15); }
    .color { padding: 0 0.5em; }
    .hint  { font-size: 60%; color: #222; opacity: .8; margin: .25em 0 0 0; }
  </style>
  <script>
    let ctx = null, cvs = null;
    let originalImageData = null;
    const maskCache = new Map();

    function handle() {
      const file = document.getElementById("upload").files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e2) => {
        const img = new Image();
        img.onload = () => {
          cvs = document.getElementById("scribble");
          cvs.width = img.width;
          cvs.height = img.height;

          ctx = cvs.getContext("2d");
          ctx.drawImage(img, 0, 0);
          originalImageData = ctx.getImageData(0, 0, cvs.width, cvs.height);

          // âœ… reset caches and view for NEW image
          maskCache.clear();
          removeHighlight();

          const data = originalImageData.data;
          const stringCounts = {};

          for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
            if (a === 0) continue;
            const hex = `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
            if (!stringCounts[hex]) stringCounts[hex] = { count: 0, rgb: [r,g,b] };
            stringCounts[hex].count++;
          }

          const colorList = document.getElementById("colorList");
          colorList.innerHTML = "";

          Object.entries(stringCounts)
            .sort((a, b) => b[1].count - a[1].count)
            .forEach(([hex, info]) => {
              const li = document.createElement("li");
              const bright = Math.sqrt(
                0.299*Math.pow(info.rgb[0]/255,2) +
                0.587*Math.pow(info.rgb[1]/255,2) +
                0.114*Math.pow(info.rgb[2]/255,2)
              ) >= 0.5;
              const pct = Math.round(info.count / (cvs.width * cvs.height) * 1000) / 10;

              li.innerHTML = `<span class="color" style="color:${hex}; background-color:${bright ? 'black' : 'white'}">${hex}:</span> ${info.count} pixels (${pct}%)`;
              li.dataset.color = hex;

              // Hold-to-highlight
              li.addEventListener('pointerdown', (ev) => {
                ev.preventDefault();
                applyHighlight(hex);
                const end = () => {
                  removeHighlight();
                  window.removeEventListener('pointerup', end, true);
                  window.removeEventListener('pointercancel', end, true);
                  window.removeEventListener('blur', end, true);
                };
                window.addEventListener('pointerup', end, true);
                window.addEventListener('pointercancel', end, true);
                window.addEventListener('blur', end, true);
              });

              colorList.appendChild(li);
            });

          document.getElementById("hint").style.display = 'block';
        };
        img.src = e2.target.result;
      };
      reader.readAsDataURL(file);
    }

    function applyHighlight(hex) {
      if (!ctx || !originalImageData) return;
      ctx.putImageData(originalImageData, 0, 0);
      ctx.save();
      ctx.globalAlpha = 0.65;
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, cvs.width, cvs.height);
      ctx.restore();
      ctx.putImageData(getMask(hex), 0, 0);
    }

    function removeHighlight() {
      if (!ctx || !originalImageData) return;
      ctx.putImageData(originalImageData, 0, 0);
    }

    function getMask(hex) {
      if (maskCache.has(hex)) return maskCache.get(hex);

      const w = cvs.width, h = cvs.height;
      const src = originalImageData.data;
      const mask = ctx.createImageData(w, h);
      const dst = mask.data;

      const rT = parseInt(hex.slice(1,3), 16);
      const gT = parseInt(hex.slice(3,5), 16);
      const bT = parseInt(hex.slice(5,7), 16);

      for (let i = 0; i < src.length; i += 4) {
        const r = src[i], g = src[i+1], b = src[i+2], a = src[i+3];
        if (a !== 0 && r === rT && g === gT && b === bT) {
          dst[i]   = Math.min(255, Math.round(r * 1.15));
          dst[i+1] = Math.min(255, Math.round(g * 1.15));
          dst[i+2] = Math.min(255, Math.round(b * 1.15));
          dst[i+3] = 255;
        } else {
          dst[i+3] = 0;
        }
      }

      maskCache.set(hex, mask);
      return mask;
    }
  </script>
</head>
<body>
  <canvas id="scribble" width="600" height="600"></canvas><br />
  <ol id="colorList"></ol>
  <div id="hint" class="hint" style="display:none;">
    Hold mouse (or touch) on a row to highlight that color; release to return to normal.
  </div>
  <input id="upload" onchange="handle()" type="file" name="upload" />
</body>
</html>
